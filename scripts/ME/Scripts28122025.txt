-- Table: public.orders

-- DROP TABLE IF EXISTS public.orders;

CREATE TABLE IF NOT EXISTS public.orders
(
    id integer NOT NULL GENERATED ALWAYS AS IDENTITY ( INCREMENT 1 START 1 MINVALUE 1 MAXVALUE 2147483647 CACHE 1 ),
    order_number character varying(8) COLLATE pg_catalog."default" NOT NULL,
    order_date date DEFAULT CURRENT_DATE,
    customer_id integer,
    customer_name character varying(100) COLLATE pg_catalog."default",
    customer_phone character varying(20) COLLATE pg_catalog."default",
    salesman_id integer,
    currency_id integer,
    exchange_rate numeric(10,4) DEFAULT 1,
    delivery_date timestamp without time zone,
    discount_amount numeric(12,2) DEFAULT 0,
    discount_type integer,
    vat_amount numeric(12,2) DEFAULT 0,
    vat_percent numeric(12,2) DEFAULT 0,
    total_amount numeric(12,2) DEFAULT 0,
    order_type integer DEFAULT 1,
    order_status integer DEFAULT 0,
    order_decision integer DEFAULT 0,
    delivery_address character varying(150) COLLATE pg_catalog."default" NOT NULL,
    reference_number character varying(30) COLLATE pg_catalog."default" NOT NULL,
    created_at timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
    updated_at timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
    shipping_cost numeric(12,2) DEFAULT 0,
    other_charges numeric(12,2) DEFAULT 0,
    general_notes character varying(300) COLLATE pg_catalog."default",
    internal_notes character varying(300) COLLATE pg_catalog."default",
    delivery_notes character varying(300) COLLATE pg_catalog."default",
    deleted boolean NOT NULL DEFAULT false,
    CONSTRAINT orders_pkey PRIMARY KEY (id),
    CONSTRAINT sales_orders_order_number_key UNIQUE (order_number),
    CONSTRAINT sales_orders_customer_id_fkey FOREIGN KEY (customer_id)
        REFERENCES public.customers (id) MATCH SIMPLE
        ON UPDATE NO ACTION
        ON DELETE NO ACTION
)



CREATE TABLE IF NOT EXISTS public.order_items
(
    id integer NOT NULL DEFAULT nextval('order_items_id_seq'::regclass),
    order_id integer NOT NULL,
    product_id integer NOT NULL,
    product_name character varying(255) COLLATE pg_catalog."default" NOT NULL,
    quantity numeric(12,2) NOT NULL DEFAULT 0,
    price numeric(12,2) NOT NULL DEFAULT 0,
    discount numeric(12,2) NOT NULL DEFAULT 0,
    barcode character varying(100) COLLATE pg_catalog."default",
    unit_id integer,
    store_id integer,
    delivered_quantity numeric(12,2) NOT NULL DEFAULT 0,
    expiry_date date,
    batch_number character varying(30) COLLATE pg_catalog."default",
    item_status integer,
    created_at timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
    updated_at timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
    bonus double precision DEFAULT 0,
    CONSTRAINT order_items_pkey PRIMARY KEY (id),
    CONSTRAINT fk_order FOREIGN KEY (order_id)
        REFERENCES public.orders (id) MATCH SIMPLE
        ON UPDATE NO ACTION
        ON DELETE CASCADE
)

CREATE TABLE stock_batch (
  id SERIAL PRIMARY KEY,

  product_id INTEGER NOT NULL,
  order_id INTEGER NOT NULL,
  status_id INTEGER NOT NULL,

  created_at TIMESTAMP NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMP NOT NULL DEFAULT NOW(),

  CONSTRAINT fk_stock_batch_product
    FOREIGN KEY (product_id) REFERENCES products(id),

  CONSTRAINT fk_stock_batch_order
    FOREIGN KEY (order_id) REFERENCES orders(id)

);



CREATE TABLE IF NOT EXISTS public.access_category
(
    id integer NOT NULL DEFAULT nextval('access_category_id_seq'::regclass),
    name character varying(100) COLLATE pg_catalog."default" NOT NULL,
    CONSTRAINT access_category_pkey PRIMARY KEY (id)
);

CREATE TABLE IF NOT EXISTS public.access_list
(
    id integer NOT NULL DEFAULT nextval('access_list_id_seq'::regclass),
    name character varying(255) COLLATE pg_catalog."default" NOT NULL,
    category_id integer,
    CONSTRAINT access_list_pkey PRIMARY KEY (id),
    CONSTRAINT fk_access_list_category FOREIGN KEY (category_id)
        REFERENCES public.access_category (id) MATCH SIMPLE
        ON UPDATE NO ACTION
        ON DELETE SET NULL
);



CREATE TABLE IF NOT EXISTS public.user_access
(
    id integer NOT NULL DEFAULT nextval('user_access_id_seq'::regclass),
    user_id integer NOT NULL,
    access_id integer NOT NULL,
    is_granted boolean NOT NULL DEFAULT false,
    created_at timestamp without time zone NOT NULL DEFAULT now(),
    updated_at timestamp without time zone NOT NULL DEFAULT now(),
    CONSTRAINT user_access_pkey PRIMARY KEY (id),
    CONSTRAINT uq_user_access UNIQUE (user_id, access_id),
    CONSTRAINT fk_user_access_access FOREIGN KEY (access_id)
        REFERENCES public.access_list (id) MATCH SIMPLE
        ON UPDATE NO ACTION
        ON DELETE CASCADE,
    CONSTRAINT fk_user_access_user FOREIGN KEY (user_id)
        REFERENCES public.user_settings (id) MATCH SIMPLE
        ON UPDATE NO ACTION
        ON DELETE CASCADE
);

 INSERT INTO access_category (name)
  VALUES 
    ('الملفات والتعريفات'),
    ('الحركات'),
    ('التقارير')
  ON CONFLICT (id) DO NOTHING;

INSERT INTO access_list (id, name, category_id)
VALUES
  (1, 'ادخال صنف', 1),
  (2, 'تعديل صنف', 1),
  (3, 'حذف صنف', 1),
  (4, 'ادخال طلبية مشتريات', 2),
  (5, 'تعديل طلبية مشتريات', 2),
  (6, 'حذف طلبية مشتريات', 2),
  (7, 'نسخ طلبية مشتريات', 2),
  (8, 'استعلام طلبية مشتريات', 2),
  (9, 'طباعة طلبية مشتريات', 2),
  (10, 'استعلام الاصناف', 1)
ON CONFLICT (id) DO NOTHING;






